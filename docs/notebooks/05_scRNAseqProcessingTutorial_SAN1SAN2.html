
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Pre-processing CellRanger outputs (multiple samples, Human PBMCs) &#8212; PIASO 0.1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=362ab14a" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=0330b353" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=01f34227"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/05_scRNAseqProcessingTutorial_SAN1SAN2';</script>
    <script src="../_static/sidebar_toggle.js?v=3b053ec6"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Pre-processing CellRanger outputs (single sample, mouse brain)" href="rnaSeqPipelineTutorial_mouse.html" />
    <link rel="prev" title="Pre-processing CellRanger outputs (single sample, Human PBMCs)" href="scRNAseqProcessingTutorial_SAN2.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/PIASO_logo.png" class="logo__image only-light" alt="PIASO 0.1.0 documentation - Home"/>
    <img src="../_static/PIASO_logo.png" class="logo__image only-dark pst-js-only" alt="PIASO 0.1.0 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../installation.html">
    Installation
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../modules.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../references.html">
    References
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../releaseNotes.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/genecell/PIASO" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../installation.html">
    Installation
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../modules.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../references.html">
    References
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../releaseNotes.html">
    Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/genecell/PIASO" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<h3><a href="../index.html">Table of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releaseNotes.html">Release notes</a></li>
</ul>
</div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../tutorials.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Pre-processing CellRanger outputs (multiple samples, Human PBMCs)</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Pre-processing-CellRanger-outputs-(multiple-samples,-Human-PBMCs)">
<h1>Pre-processing CellRanger outputs (multiple samples, Human PBMCs)<a class="headerlink" href="#Pre-processing-CellRanger-outputs-(multiple-samples,-Human-PBMCs)" title="Link to this heading">#</a></h1>
<p>This notebook demonstrates the pipeline for processing scRNA-seq data, covering metric computation, normalization, clustering, cell type prediction, and the identification/removal of doublets and low-quality clusters. The final output is pre-processed, annotated scRNA-seq data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import piaso
import cosg
import numpy as np
import pandas as pd
import scanpy as sc
import logging
from sklearn.preprocessing import StandardScaler
import warnings
import os
import anndata as ad

from matplotlib import rcParams
sc.settings.set_figure_params(scanpy=True, dpi=80, dpi_save=300, frameon=True, vector_friendly=False, fontsize=14)
import matplotlib as mpl
mpl.rcParams[&#39;pdf.fonttype&#39;] = 42
mpl.rcParams[&#39;ps.fonttype&#39;] = 42
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/n/data1/hms/neurobio/fishell/vallaris/.conda/envs/piaso_env/lib/python3.10/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data_dir = &quot;/n/scratch/users/v/vas744/Data/Public/PBMCMultiomeRop2023&quot;
save_dir = &quot;/n/scratch/users/v/vas744/Results/single-cell/Methods/DataProcessing/PBMCMultiomeRop2023_SAN1_SAN2&quot;
prefix = &quot;HumanPBMCs_Multiome_RNA&quot;
</pre></div>
</div>
</div>
<section id="Download-the-data">
<h2>Download the data<a class="headerlink" href="#Download-the-data" title="Link to this heading">#</a></h2>
<p>Human PBMC snMultiome data (SAN1, SAN2) from: De Rop, F.V., Hulselmans, G., Flerin, C. et al. Systematic benchmarking of single-cell ATAC-sequencing protocols. Nat Biotechnol 42, 916–926 (2024). <a class="reference external" href="https://doi.org/10.1038/s41587-023-01881-x">https://doi.org/10.1038/s41587-023-01881-x</a></p>
<p>Also available via <a class="reference external" href="https://drive.google.com/file/d/1g1V-VTy2qHK7PJIbW-t9hRFzHCqFCe4T/view?usp=drive_link">https://drive.google.com/file/d/1g1V-VTy2qHK7PJIbW-t9hRFzHCqFCe4T/view?usp=drive_link</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># !/home/vas744/Software/gdrive files download --destination /n/scratch/users/v/vas744/Data/Public/PBMCMultiomeRop2023 1g1V-VTy2qHK7PJIbW-t9hRFzHCqFCe4T
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!/home/vas744/Software/gdrive files download --destination /n/scratch/users/v/vas744/Data/Public/PBMCMultiomeRop2023/SAN2 1q5mXAE6YWVlzTJLSG0qUgnATitml0gzX
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Downloading filtered_feature_bc_matrix.h5
Successfully downloaded filtered_feature_bc_matrix.h5
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!/home/vas744/Software/gdrive files download --destination /n/scratch/users/v/vas744/Data/Public/PBMCMultiomeRop2023/SAN1 1Bjr81oJWto-06ak14IXB804xcLypPbRj
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Downloading filtered_feature_bc_matrix.h5
Successfully downloaded filtered_feature_bc_matrix.h5
</pre></div></div>
</div>
</section>
<section id="Load-the-data">
<h2>Load the data<a class="headerlink" href="#Load-the-data" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>data_path=&#39;/n/scratch/users/v/vas744/Data/Public/PBMCMultiomeRop2023&#39;
samples = [entry.name for entry in os.scandir(data_path) if entry.is_dir()]
print(samples)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;SAN1&#39;, &#39;SAN2&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def load_multiple_anndata(
    data_path,
    samples,
    key_added):
    anndata_list = []
    for sample in samples:
        try:
            # Load the data
            file_name = os.listdir(data_path+&#39;/&#39;+sample+&#39;/RNA&#39;)[0]
            print(file_name)
            h5_path=data_path+&#39;/&#39;+sample+&#39;/RNA/&#39;+file_name
            if os.path.exists(h5_path):
                adata = sc.read_10x_h5(h5_path)
                print(&#39;Loading the h5 file&#39;)

            else:
                adata = sc.read_10x_mtx(data_path+&#39;/&#39;+sample, cache=True)
            adata.var_names_make_unique()
            adata.obs_names_make_unique()
            adata.obs[key_added]=sample
            anndata_list.append(adata)
            print(&#39;Sample loaded: &#39;, sample)
        except Exception as e:
            print(f&quot;Error loading {data_path}: {e}&quot;)

    return anndata_list
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata_list=load_multiple_anndata(data_path=data_path, samples=samples, key_added=&#39;Sample&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
filtered_feature_bc_matrix.h5
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/n/data1/hms/neurobio/fishell/vallaris/.conda/envs/piaso_env/lib/python3.10/site-packages/anndata/_core/anndata.py:1758: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.
  utils.warn_names_duplicates(&#34;var&#34;)
/n/data1/hms/neurobio/fishell/vallaris/.conda/envs/piaso_env/lib/python3.10/site-packages/anndata/_core/anndata.py:1758: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.
  utils.warn_names_duplicates(&#34;var&#34;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Loading the h5 file
Sample loaded:  SAN1
filtered_feature_bc_matrix.h5
Loading the h5 file
Sample loaded:  SAN2
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/n/data1/hms/neurobio/fishell/vallaris/.conda/envs/piaso_env/lib/python3.10/site-packages/anndata/_core/anndata.py:1758: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.
  utils.warn_names_duplicates(&#34;var&#34;)
/n/data1/hms/neurobio/fishell/vallaris/.conda/envs/piaso_env/lib/python3.10/site-packages/anndata/_core/anndata.py:1758: UserWarning: Variable names are not unique. To make them unique, call `.var_names_make_unique`.
  utils.warn_names_duplicates(&#34;var&#34;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata_list
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[AnnData object with n_obs × n_vars = 3545 × 36601
     obs: &#39;Sample&#39;
     var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;interval&#39;,
 AnnData object with n_obs × n_vars = 4360 × 36601
     obs: &#39;Sample&#39;
     var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;interval&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata=ad.concat(adata_list, join=&#39;outer&#39;,index_unique=&quot;-&quot;)
adata
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 7905 × 36601
    obs: &#39;Sample&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.X.data
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 1.,  1.,  1., ..., 43., 18., 56.],
      shape=(12509350,), dtype=float32)
</pre></div></div>
</div>
<p>Create the ‘raw’ counts layer based on the counts data from the adata object.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.layers[&#39;raw&#39;] = adata.X.copy()
adata
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 7905 × 36601
    obs: &#39;Sample&#39;
    layers: &#39;raw&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.var
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>MIR1302-2HG</th>
    </tr>
    <tr>
      <th>FAM138A</th>
    </tr>
    <tr>
      <th>OR4F5</th>
    </tr>
    <tr>
      <th>AL627309.1</th>
    </tr>
    <tr>
      <th>AL627309.3</th>
    </tr>
    <tr>
      <th>...</th>
    </tr>
    <tr>
      <th>AC141272.1</th>
    </tr>
    <tr>
      <th>AC023491.2</th>
    </tr>
    <tr>
      <th>AC007325.1</th>
    </tr>
    <tr>
      <th>AC007325.4</th>
    </tr>
    <tr>
      <th>AC007325.2</th>
    </tr>
  </tbody>
</table>
<p>36601 rows × 0 columns</p>
</div></div>
</div>
</section>
<section id="Quality-Control">
<h2>Quality Control<a class="headerlink" href="#Quality-Control" title="Link to this heading">#</a></h2>
<section id="Filter-cells-based-on-gene-counts">
<h3>Filter cells based on gene counts<a class="headerlink" href="#Filter-cells-based-on-gene-counts" title="Link to this heading">#</a></h3>
<p>Filter out cells with fewer than 200 detected genes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pp.filter_cells(adata, min_genes=200)
</pre></div>
</div>
</div>
</section>
<section id="Calculate-cell-quality-metrics">
<h3>Calculate cell quality metrics<a class="headerlink" href="#Calculate-cell-quality-metrics" title="Link to this heading">#</a></h3>
<p>We identify mitochondrial and ribosomal protein genes and compute their proportion in each cell’s total read count. A high proportion of these reads often indicates low-quality cells. Note: In human data, the gene names have uppercase letters (MT-, RPS-, RPL-). For mouse data, these gene names will start with Mt-, Rps-, Rpl-</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.var[&#39;mt&#39;] = adata.var_names.str.startswith(&#39;MT-&#39;)
sc.pp.calculate_qc_metrics(adata, qc_vars=[&#39;mt&#39;], percent_top=None, log1p=False, inplace=True)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.var[&#39;ribo&#39;] = adata.var_names.str.startswith(&#39;RPS&#39;,&#39;RPL&#39;)
sc.pp.calculate_qc_metrics(adata, qc_vars=[&#39;ribo&#39;], percent_top=None, log1p=False, inplace=True)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2699886/3834852883.py:1: FutureWarning: Allowing a non-bool &#39;na&#39; in obj.str.startswith is deprecated and will raise in a future version.
  adata.var[&#39;ribo&#39;] = adata.var_names.str.startswith(&#39;RPS&#39;,&#39;RPL&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>piaso.pl.plot_features_violin(adata,
                              [&#39;n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;pct_counts_mt&#39;,&#39;pct_counts_ribo&#39;],
                              width_single=2.0)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_24_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_24_0.png" style="width: 217px; height: 581px;" />
</div>
</div>
</section>
<section id="Doublet-prediction">
<h3>Doublet prediction<a class="headerlink" href="#Doublet-prediction" title="Link to this heading">#</a></h3>
<p>Next, we compute the scrublet score to identify and predict potential doublets.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>experiments=np.unique(adata.obs[&#39;Sample&#39;])
adata.obs[&#39;scrublet_score&#39;]=np.repeat(0,adata.n_obs)
adata.obs[&#39;predicted_doublets&#39;]=np.repeat(False,adata.n_obs)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import scrublet as scr

for experiment in experiments:
    print(experiment)
    adatai=adata[adata.obs[&#39;Sample&#39;]==experiment]

    scrub = scr.Scrublet(adatai.X.todense(),random_state=10)
    doublet_scores, predicted_doublets = scrub.scrub_doublets()

    adata.obs[&#39;predicted_doublets&#39;][adatai.obs_names]=predicted_doublets

    adata.obs[&#39;scrublet_score&#39;][adatai.obs_names]=doublet_scores
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SAN1
Preprocessing...
Simulating doublets...
Embedding transcriptomes using PCA...
Calculating doublet scores...
Automatically set threshold at doublet score = 0.15
Detected doublet rate = 15.9%
Estimated detectable doublet fraction = 77.1%
Overall doublet rate:
        Expected   = 10.0%
        Estimated  = 20.6%
Elapsed time: 3.1 seconds
SAN2
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2699886/3464195482.py:10: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&#34;col&#34;][row_indexer] = value

Use `df.loc[row_indexer, &#34;col&#34;] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy

  adata.obs[&#39;predicted_doublets&#39;][adatai.obs_names]=predicted_doublets
/tmp/ipykernel_2699886/3464195482.py:10: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  adata.obs[&#39;predicted_doublets&#39;][adatai.obs_names]=predicted_doublets
/tmp/ipykernel_2699886/3464195482.py:12: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!
You are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.
A typical example is when you are setting values in a column of a DataFrame, like:

df[&#34;col&#34;][row_indexer] = value

Use `df.loc[row_indexer, &#34;col&#34;] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy

  adata.obs[&#39;scrublet_score&#39;][adatai.obs_names]=doublet_scores
/tmp/ipykernel_2699886/3464195482.py:12: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  adata.obs[&#39;scrublet_score&#39;][adatai.obs_names]=doublet_scores
/tmp/ipykernel_2699886/3464195482.py:12: FutureWarning: Setting an item of incompatible dtype is deprecated and will raise an error in a future version of pandas. Value &#39;[0.14470842 0.05152225 0.06938776 ... 0.09004739 0.03024575 0.04338395]&#39; has dtype incompatible with int64, please explicitly cast to a compatible dtype first.
  adata.obs[&#39;scrublet_score&#39;][adatai.obs_names]=doublet_scores
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Preprocessing...
Simulating doublets...
Embedding transcriptomes using PCA...
Calculating doublet scores...
Automatically set threshold at doublet score = 0.14
Detected doublet rate = 17.1%
Estimated detectable doublet fraction = 79.9%
Overall doublet rate:
        Expected   = 10.0%
        Estimated  = 21.5%
Elapsed time: 5.5 seconds
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_2699886/3464195482.py:10: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  adata.obs[&#39;predicted_doublets&#39;][adatai.obs_names]=predicted_doublets
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>piaso.pl.plot_features_violin(adata,
                              [&#39;scrublet_score&#39;],
                              groupby=&#39;Sample&#39;,
                              width_single=2)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_28_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_28_0.png" style="width: 189px; height: 204px;" />
</div>
</div>
</section>
</section>
<section id="log1p-Normalization">
<h2>log1p Normalization<a class="headerlink" href="#log1p-Normalization" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
sc.pp.normalize_total(adata, target_sum=1e4)
sc.pp.log1p(adata)

adata.layers[&#39;log1p&#39;]=adata.X.copy()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 198 ms, sys: 26.5 ms, total: 225 ms
Wall time: 124 ms
</pre></div></div>
</div>
</section>
<section id="INFOG-Normalization">
<h2>INFOG Normalization<a class="headerlink" href="#INFOG-Normalization" title="Link to this heading">#</a></h2>
<p>We use PIASO’s INFOG to normalize the data and identify a highly variable set of genes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
piaso.tl.infog(adata,
               copy=False,
               inplace=False,
               n_top_genes=3000,
               key_added=&#39;infog&#39;,
               key_added_highly_variable_gene=&#39;highly_variable&#39;,
               layer=&#39;raw&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The normalized data is saved as `infog` in `adata.layers`.
The highly variable genes are saved as `highly_variable` in `adata.var`.
Finished INFOG normalization.
CPU times: user 590 ms, sys: 199 ms, total: 789 ms
Wall time: 792 ms
</pre></div></div>
</div>
</section>
<section id="Dimensionality-reduction">
<h2>Dimensionality reduction<a class="headerlink" href="#Dimensionality-reduction" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
piaso.tl.runSVD(adata,
                use_highly_variable=True,
                n_components=30,
                random_state=10,
                key_added=&#39;X_svd&#39;,
                layer=&#39;infog&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 4.07 s, sys: 6.2 ms, total: 4.07 s
Wall time: 493 ms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
sc.pp.neighbors(adata,
                use_rep=&#39;X_svd&#39;,
                n_neighbors=15,
                random_state=10,
                knn=True,
                method=&quot;umap&quot;)

sc.tl.umap(adata)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 27.5 s, sys: 92.7 ms, total: 27.6 s
Wall time: 24.2 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;n_genes_by_counts&#39;, &#39;total_counts&#39;,&#39;pct_counts_mt&#39;,&#39;pct_counts_ribo&#39;, &#39;scrublet_score&#39;],
           cmap=&#39;Spectral_r&#39;,
           palette=piaso.pl.color.d_color1,
           ncols=2,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_36_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_36_0.png" style="width: 666px; height: 837px;" />
</div>
</div>
</section>
<section id="Save-the-data">
<h2>Save the data<a class="headerlink" href="#Save-the-data" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>save_dir+&#39;/&#39;+prefix+&#39;_raw_QC.h5ad&#39;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;/n/scratch/users/v/vas744/Results/single-cell/Methods/DataProcessing/PBMCMultiomeRop2023_SAN1_SAN2/HumanPBMCs_Multiome_RNA_raw_QC.h5ad&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.write(save_dir+&#39;/&#39;+prefix+&#39;_raw_QC.h5ad&#39;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># adata = sc.read(save_dir+&#39;/&#39;+prefix+&#39;_raw_QC.h5ad&#39;)
</pre></div>
</div>
</div>
</section>
<section id="Filtering-cells">
<h2>Filtering cells<a class="headerlink" href="#Filtering-cells" title="Link to this heading">#</a></h2>
<p>Outlier cells of these thresholds are likely low quality cells, so we filter them out before further downstream analysis.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata=adata[adata.obs[&#39;n_genes_by_counts&#39;]&gt;500].copy()
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata=adata[adata.obs[&#39;n_genes_by_counts&#39;]&lt;10000].copy()
</pre></div>
</div>
</div>
<p>Remove doublets based on a scrublet score threshold.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata = adata[adata.obs[&#39;scrublet_score&#39;]&lt;0.3].copy()
adata
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 7218 × 36601
    obs: &#39;Sample&#39;, &#39;n_genes&#39;, &#39;n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;total_counts_mt&#39;, &#39;pct_counts_mt&#39;, &#39;total_counts_ribo&#39;, &#39;pct_counts_ribo&#39;, &#39;scrublet_score&#39;, &#39;predicted_doublets&#39;
    var: &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;ribo&#39;, &#39;infog_var&#39;, &#39;highly_variable&#39;
    uns: &#39;Sample_colors&#39;, &#39;log1p&#39;, &#39;neighbors&#39;, &#39;umap&#39;
    obsm: &#39;X_svd&#39;, &#39;X_umap&#39;
    layers: &#39;infog&#39;, &#39;log1p&#39;, &#39;raw&#39;
    obsp: &#39;connectivities&#39;, &#39;distances&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;n_genes_by_counts&#39;, &#39;total_counts&#39;,&#39;pct_counts_mt&#39;,&#39;pct_counts_ribo&#39;, &#39;scrublet_score&#39;],
           cmap=&#39;Spectral_r&#39;,
           palette=piaso.pl.color.d_color1,
           ncols=2,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_46_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_46_0.png" style="width: 666px; height: 837px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>piaso.pl.plot_embeddings_split(adata,
                               color=&#39;n_genes_by_counts&#39;,
                               cmap=piaso.pl.color.c_color1,
                               palette=piaso.pl.color.d_color1,
                               layer=None,
                               splitby=&#39;Sample&#39;,
                               size=25,
                               frameon=False,)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_47_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_47_0.png" style="width: 582px; height: 354px;" />
</div>
</div>
</section>
<section id="Annotation">
<h2>Annotation<a class="headerlink" href="#Annotation" title="Link to this heading">#</a></h2>
<p>We used the precomputed Human PBMC marker gene sets from the <code class="docutils literal notranslate"><span class="pre">AllenHumanImmuneHealthAtlas_L2</span></code> study in PIASOmarkerDB. The original dataset comes from <a class="reference external" href="https://www.nature.com/articles/s41586-025-09686-5">https://www.nature.com/articles/s41586-025-09686-5</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>marker_gene_df = pd.read_csv(&quot;/n/scratch/users/v/vas744/Data/Public/10x_Human_PBMC/PIASOmarkerDB_AllenHumanImmuneHealthAtlas_L2_251219.csv&quot;)
marker_gene_df
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Cell_Type</th>
      <th>Gene</th>
      <th>Specificity_Score</th>
      <th>Study_Publication</th>
      <th>Species</th>
      <th>Tissue</th>
      <th>Condition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Platelet</td>
      <td>GP9</td>
      <td>16.455748</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Erythrocyte</td>
      <td>ALAS2</td>
      <td>16.422475</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Platelet</td>
      <td>CMTM5</td>
      <td>16.400534</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Platelet</td>
      <td>TMEM40</td>
      <td>16.373334</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Erythrocyte</td>
      <td>AHSP</td>
      <td>16.338337</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1445</th>
      <td>Memory CD4 T cell</td>
      <td>FXYD7</td>
      <td>1.783520</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>1446</th>
      <td>Memory CD4 T cell</td>
      <td>CRIP1</td>
      <td>1.779265</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>1447</th>
      <td>Memory CD4 T cell</td>
      <td>CCDC167</td>
      <td>1.775660</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>1448</th>
      <td>Memory CD4 T cell</td>
      <td>CD6</td>
      <td>1.775110</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
    <tr>
      <th>1449</th>
      <td>Memory CD4 T cell</td>
      <td>TMEM238</td>
      <td>1.769377</td>
      <td>AllenHumanImmuneHealthAtlas_L2</td>
      <td>Human</td>
      <td>blood</td>
      <td>normal</td>
    </tr>
  </tbody>
</table>
<p>1450 rows × 7 columns</p>
</div></div>
</div>
<section id="Preprocessing-cell-type-specific-marker-gene-sets">
<h3>Preprocessing cell type-specific marker gene sets<a class="headerlink" href="#Preprocessing-cell-type-specific-marker-gene-sets" title="Link to this heading">#</a></h3>
<p>PIASO’s predictCellTypeByMarker expects the marker_gene_list in DataFrame or dict format. So here, we will create a dictionary with each cell type and their respective marker gene lists.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>marker_gene_dict = {}
cell_types = np.unique(marker_gene_df[&#39;Cell_Type&#39;])
for cell_type in cell_types:
    marker_gene_dict[cell_type] = list(marker_gene_df[marker_gene_df[&#39;Cell_Type&#39;]==cell_type][&#39;Gene&#39;])
</pre></div>
</div>
</div>
<p>Reordering cell type categories</p>
</section>
<section id="1.-INFOG-Normalization">
<h3>1. INFOG Normalization<a class="headerlink" href="#1.-INFOG-Normalization" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
piaso.tl.infog(adata,
               copy=False,
               inplace=False,
               n_top_genes=3000,
               key_added=&#39;infog&#39;,
               key_added_highly_variable_gene=&#39;highly_variable&#39;,
               layer=&#39;raw&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The normalized data is saved as `infog` in `adata.layers`.
The highly variable genes are saved as `highly_variable` in `adata.var`.
Finished INFOG normalization.
CPU times: user 747 ms, sys: 28.8 s, total: 29.5 s
Wall time: 29.6 s
</pre></div></div>
</div>
</section>
<section id="id2">
<h3>Dimensionality reduction<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
piaso.tl.runSVD(adata,
                use_highly_variable=True,
                n_components=30,
                random_state=10,
                key_added=&#39;X_svd&#39;,
                layer=&#39;infog&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 5.36 s, sys: 134 ms, total: 5.5 s
Wall time: 894 ms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
sc.pp.neighbors(adata,
                use_rep=&#39;X_svd&#39;,
                n_neighbors=15,
                random_state=10,
                knn=True,
                method=&quot;umap&quot;)

sc.tl.umap(adata)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 39.3 s, sys: 308 ms, total: 39.6 s
Wall time: 36.3 s
</pre></div></div>
</div>
</section>
<section id="Predict-cell-types-based-on-marker-gene-sets">
<h3>Predict cell types based on marker gene sets<a class="headerlink" href="#Predict-cell-types-based-on-marker-gene-sets" title="Link to this heading">#</a></h3>
<p>Here, we use the <code class="docutils literal notranslate"><span class="pre">use_score</span> <span class="pre">=</span> <span class="pre">False</span></code> to make the predictions based on p-values, but you can also use the gene set scores with <code class="docutils literal notranslate"><span class="pre">use_score</span> <span class="pre">=</span> <span class="pre">True</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
piaso.tl.predictCellTypeByMarker(adata,
                                 marker_gene_set=marker_gene_dict,
                                 score_method=&#39;piaso&#39;,
                                 use_rep=&#39;X_svd&#39;,
                                 use_score=False,
                                 smooth_prediction=True,
                                 inplace=True)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Calculating gene set scores using piaso method...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Scoring gene sets: 100%|██████████| 29/29 [00:16&lt;00:00,  1.75set/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Predicting cell types based on marker gene p-values...
Smoothing cell type predictions...
Smoothing cell type predictions from &#39;CellTypes_predicted_raw&#39; using 7-nearest neighbors
Smoothed predictions stored in adata.obs[&#39;CellTypes_predicted_smoothed&#39;]
Confidence scores stored in adata.obs[&#39;CellTypes_predicted_smoothed_confidence&#39;]
Modified 1632 cell labels (22.61% of total)
Cell type prediction completed. Results saved to:
  - adata.obs[&#39;CellTypes_predicted&#39;]: predicted cell types
  - adata.obsm[&#39;CellTypes_predicted_score&#39;]: full score matrix
  - adata.obsm[&#39;CellTypes_predicted_nlog10pvals&#39;]: full -log10(p-value) matrix
  - adata.obs[&#39;CellTypes_predicted_nlog10pvals&#39;]: maximum -log10(p-values)
  - adata.obs[&#39;CellTypes_predicted_raw&#39;]: original unsmoothed predictions
  - adata.obs[&#39;CellTypes_predicted_confidence_smoothed&#39;]: smoothing confidence scores
CPU times: user 6.85 s, sys: 146 ms, total: 6.99 s
Wall time: 24.6 s
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>category_dict = {&quot;Human_PBMC&quot;: [&#39;ASDC&#39;, &#39;CD14 monocyte&#39;, &#39;CD16 monocyte&#39;, &#39;CD56bright NK cell&#39;,
                                &#39;CD56dim NK cell&#39;, &#39;CD8aa&#39;, &#39;DN T cell&#39;, &#39;Effector B cell&#39;,
                                &#39;Erythrocyte&#39;, &#39;ILC&#39;, &#39;Intermediate monocyte&#39;, &#39;MAIT&#39;, &#39;Memory B cell&#39;,
                                &#39;Memory CD4 T cell&#39;, &#39;Memory CD8 T cell&#39;, &#39;Naive B cell&#39;,
                                &#39;Naive CD4 T cell&#39;, &#39;Naive CD8 T cell&#39;, &#39;Plasma cell&#39;, &#39;Platelet&#39;,
                                &#39;Progenitor cell&#39;,&#39;Proliferating NK cell&#39;, &#39;Proliferating T cell&#39;,
                                &#39;Transitional B cell&#39;, &#39;Treg&#39;, &#39;cDC1&#39;,&#39;cDC2&#39;, &#39;gdT&#39;,&#39;pDC&#39;]}
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cell_types
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;ASDC&#39;, &#39;CD14 monocyte&#39;, &#39;CD16 monocyte&#39;, &#39;CD56bright NK cell&#39;,
       &#39;CD56dim NK cell&#39;, &#39;CD8aa&#39;, &#39;DN T cell&#39;, &#39;Effector B cell&#39;,
       &#39;Erythrocyte&#39;, &#39;ILC&#39;, &#39;Intermediate monocyte&#39;, &#39;MAIT&#39;,
       &#39;Memory B cell&#39;, &#39;Memory CD4 T cell&#39;, &#39;Memory CD8 T cell&#39;,
       &#39;Naive B cell&#39;, &#39;Naive CD4 T cell&#39;, &#39;Naive CD8 T cell&#39;,
       &#39;Plasma cell&#39;, &#39;Platelet&#39;, &#39;Progenitor cell&#39;,
       &#39;Proliferating NK cell&#39;, &#39;Proliferating T cell&#39;,
       &#39;Transitional B cell&#39;, &#39;Treg&#39;, &#39;cDC1&#39;, &#39;cDC2&#39;, &#39;gdT&#39;, &#39;pDC&#39;],
      dtype=object)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.unique(adata.obs[&#39;CellTypes_predicted&#39;])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;CD14 monocyte&#39;, &#39;CD16 monocyte&#39;, &#39;CD56bright NK cell&#39;,
       &#39;CD56dim NK cell&#39;, &#39;CD8aa&#39;, &#39;DN T cell&#39;, &#39;Effector B cell&#39;, &#39;ILC&#39;,
       &#39;Intermediate monocyte&#39;, &#39;MAIT&#39;, &#39;Memory B cell&#39;,
       &#39;Memory CD4 T cell&#39;, &#39;Memory CD8 T cell&#39;, &#39;Naive B cell&#39;,
       &#39;Naive CD4 T cell&#39;, &#39;Naive CD8 T cell&#39;, &#39;Plasma cell&#39;, &#39;Platelet&#39;,
       &#39;Progenitor cell&#39;, &#39;Proliferating NK cell&#39;, &#39;Transitional B cell&#39;,
       &#39;Treg&#39;, &#39;cDC1&#39;, &#39;cDC2&#39;, &#39;gdT&#39;, &#39;pDC&#39;], dtype=object)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.obs[&#39;CellTypes_predicted&#39;] = adata.obs[&#39;CellTypes_predicted&#39;].astype(&#39;category&#39;)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.obs[&#39;CellTypes_predicted&#39;] = adata.obs[&#39;CellTypes_predicted&#39;].cat.add_categories(
    [cat for cat in category_dict[&quot;Human_PBMC&quot;]
     if cat not in adata.obs[&#39;CellTypes_predicted&#39;].cat.categories]
)

adata.obs[&#39;CellTypes_predicted&#39;] = adata.obs[&#39;CellTypes_predicted&#39;].cat.reorder_categories(
    category_dict[&quot;Human_PBMC&quot;]
)
adata
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 7218 × 36601
    obs: &#39;Sample&#39;, &#39;n_genes&#39;, &#39;n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;total_counts_mt&#39;, &#39;pct_counts_mt&#39;, &#39;total_counts_ribo&#39;, &#39;pct_counts_ribo&#39;, &#39;scrublet_score&#39;, &#39;predicted_doublets&#39;, &#39;CellTypes_predicted&#39;, &#39;CellTypes_predicted_nlog10pvals&#39;, &#39;CellTypes_predicted_raw&#39;, &#39;CellTypes_predicted_smoothed&#39;, &#39;CellTypes_predicted_smoothed_confidence&#39;, &#39;CellTypes_predicted_confidence_smoothed&#39;
    var: &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;ribo&#39;, &#39;infog_var&#39;, &#39;highly_variable&#39;
    uns: &#39;Sample_colors&#39;, &#39;log1p&#39;, &#39;neighbors&#39;, &#39;umap&#39;
    obsm: &#39;X_svd&#39;, &#39;X_umap&#39;, &#39;CellTypes_predicted_score&#39;, &#39;CellTypes_predicted_nlog10pvals&#39;
    layers: &#39;infog&#39;, &#39;log1p&#39;, &#39;raw&#39;
    obsp: &#39;connectivities&#39;, &#39;distances&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;CellTypes_predicted&#39;],
           palette=piaso.pl.color.d_color20,
           legend_fontsize=8,
           legend_fontoutline=1,
           # legend_loc=&#39;on data&#39;,
           ncols=1,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_67_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_67_0.png" style="width: 478px; height: 277px;" />
</div>
</div>
</section>
<section id="Clustering">
<h3>Clustering<a class="headerlink" href="#Clustering" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
sc.tl.leiden(adata,resolution=2.5,key_added=&#39;Leiden&#39;)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
&lt;timed eval&gt;:1: FutureWarning: In the future, the default backend for leiden will be igraph instead of leidenalg.

 To achieve the future defaults please pass: flavor=&#34;igraph&#34; and n_iterations=2.  directed must also be False to work with igraph&#39;s implementation.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 4.01 s, sys: 16.3 ms, total: 4.02 s
Wall time: 4.05 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;CellTypes_predicted&#39;,&#39;Leiden&#39;],
           palette=piaso.pl.color.d_color20,
           legend_fontsize=12,
           legend_fontoutline=2,
           # legend_loc=&#39;on data&#39;,
           ncols=1,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_70_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_70_0.png" style="width: 614px; height: 566px;" />
</div>
</div>
</section>
<section id="Identify-marker-genes-with-COSG">
<h3>Identify marker genes with COSG<a class="headerlink" href="#Identify-marker-genes-with-COSG" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
n_gene=30
cosg.cosg(adata,
          key_added=&#39;cosg&#39;,
          use_raw=False,
          layer=&#39;infog&#39;,
          mu=100,
          expressed_pct=0.1,
          remove_lowly_expressed=True,
          n_genes_user=n_gene,
          groupby=&#39;Leiden&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 915 ms, sys: 540 ms, total: 1.46 s
Wall time: 1.47 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.tl.dendrogram(adata,groupby=&#39;Leiden&#39;,use_rep=&#39;X_svd&#39;)
df_tmp=pd.DataFrame(adata.uns[&#39;cosg&#39;][&#39;names&#39;][:3,]).T
df_tmp=df_tmp.reindex(adata.uns[&#39;dendrogram_&#39;+&#39;Leiden&#39;][&#39;categories_ordered&#39;])
marker_genes_list={idx: list(row.values) for idx, row in df_tmp.iterrows()}
marker_genes_list = {k: v for k, v in marker_genes_list.items() if not any(isinstance(x, float) for x in v)}

sc.pl.dotplot(adata,
              marker_genes_list,
              groupby=&#39;Leiden&#39;,
              layer=&#39;infog&#39;,
              dendrogram=True,
              swap_axes=False,
              standard_scale=&#39;var&#39;,
              cmap=&#39;Spectral_r&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_73_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_73_0.png" style="width: 2338px; height: 819px;" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>marker_gene=pd.DataFrame(adata.uns[&#39;cosg&#39;][&#39;names&#39;])
</pre></div>
</div>
</div>
</section>
<section id="Removal-of-low-quality-cells">
<h3>Removal of low-quality cells<a class="headerlink" href="#Removal-of-low-quality-cells" title="Link to this heading">#</a></h3>
<p>Here, we identify and remove some low quality clusters based on cell quality metrics and marker gene sets.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>piaso.pl.plot_features_violin(adata,
                              [&#39;n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;pct_counts_mt&#39;,&#39;pct_counts_ribo&#39;, &#39;scrublet_score&#39;],
                              groupby=&#39;Leiden&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_76_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_76_0.png" style="width: 959px; height: 667px;" />
</div>
</div>
<p>Some of the cells seems to have higher percentage of mitochondrial and ribosomal gene expression, indicating that they are low quality.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata = adata[adata.obs[&#39;pct_counts_mt&#39;]&lt;20].copy()
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata = adata[adata.obs[&#39;pct_counts_ribo&#39;]&lt;5].copy()
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;n_genes_by_counts&#39;, &#39;total_counts&#39;,&#39;pct_counts_mt&#39;,&#39;pct_counts_ribo&#39;, &#39;scrublet_score&#39;],
           cmap=&#39;Spectral_r&#39;,
           palette=piaso.pl.color.d_color1,
           ncols=2,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_80_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_80_0.png" style="width: 666px; height: 837px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;Leiden&#39;],
           groups=[&#39;29&#39;],
           palette=piaso.pl.color.d_color20,
           legend_fontsize=12,
           legend_fontoutline=2,
           # legend_loc=&#39;on data&#39;,
           ncols=1,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_81_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_81_0.png" style="width: 313px; height: 277px;" />
</div>
</div>
<section id="Checking-potential-low-quality-clusters">
<h4>Checking potential low quality clusters<a class="headerlink" href="#Checking-potential-low-quality-clusters" title="Link to this heading">#</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cluster_check = &#39;20&#39;
marker_gene[cluster_check].values
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;RPL19&#39;, &#39;RPL32&#39;, &#39;RPL13A&#39;, &#39;RPL28&#39;, &#39;RPS25&#39;, &#39;RPS8&#39;, &#39;RPLP2&#39;,
       &#39;RPL14&#39;, &#39;RPS12&#39;, &#39;RPS27&#39;, &#39;MKI67&#39;, &#39;RPL22&#39;, &#39;RPL23A&#39;, &#39;RPS15A&#39;,
       &#39;RPL35&#39;, &#39;RPL13&#39;, &#39;RPS18&#39;, &#39;RPL3&#39;, &#39;RPL17&#39;, &#39;RPS3&#39;, &#39;EEF1A1&#39;,
       &#39;RPS20&#39;, &#39;RPL12&#39;, &#39;RPS3A&#39;, &#39;RPL18A&#39;, &#39;RPLP0&#39;, &#39;RPS23&#39;, &#39;RPL39&#39;,
       &#39;RPS6&#39;, &#39;RPL31&#39;], dtype=object)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;IGHA1&#39;, &#39;SDC1&#39;, &#39;IGLV2-11&#39;, &#39;JCHAIN&#39;, &#39;IGHG4&#39;, &#39;TNFRSF17&#39;,
       &#39;IGLV2-14&#39;, &#39;GLDC&#39;, &#39;IGHV3-15&#39;, &#39;TXNDC5&#39;, &#39;IGHG2&#39;, &#39;MIXL1&#39;, &#39;MZB1&#39;],
           cmap=piaso.pl.color.c_color1,
           palette=piaso.pl.color.d_color1,
           ncols=3,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_84_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_84_0.png" style="width: 963px; height: 1402px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[98]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.dotplot(adata,
              marker_gene[cluster_check].values[:30],
              groupby=&#39;Leiden&#39;,
              dendrogram=False,
              swap_axes=True,
              standard_scale=&#39;var&#39;,
              cmap=&#39;Spectral_r&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_85_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_85_0.png" style="width: 872px; height: 737px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;Leiden&#39;],
           groups=[&#39;17&#39;,&#39;20&#39;,&#39;27&#39;,&#39;28&#39;],
           palette=piaso.pl.color.d_color20,
           legend_fontsize=12,
           legend_fontoutline=2,
           # legend_loc=&#39;on data&#39;,
           ncols=1,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_86_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_86_0.png" style="width: 313px; height: 277px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>piaso.pl.plot_embeddings_split(adata,
                               color=&#39;CellTypes_predicted&#39;,
                               layer=None,
                               splitby=&#39;Sample&#39;,
                               size=25,
                               frameon=False,)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_87_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_87_0.png" style="width: 1116px; height: 337px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata=adata[~adata.obs[&#39;Leiden&#39;].isin([&#39;17&#39;,&#39;20&#39;,&#39;27&#39;,&#39;28&#39;])].copy()
adata
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 6591 × 36601
    obs: &#39;Sample&#39;, &#39;n_genes&#39;, &#39;n_genes_by_counts&#39;, &#39;total_counts&#39;, &#39;total_counts_mt&#39;, &#39;pct_counts_mt&#39;, &#39;total_counts_ribo&#39;, &#39;pct_counts_ribo&#39;, &#39;scrublet_score&#39;, &#39;predicted_doublets&#39;, &#39;CellTypes_predicted&#39;, &#39;CellTypes_predicted_nlog10pvals&#39;, &#39;CellTypes_predicted_raw&#39;, &#39;CellTypes_predicted_smoothed&#39;, &#39;CellTypes_predicted_smoothed_confidence&#39;, &#39;CellTypes_predicted_confidence_smoothed&#39;, &#39;Leiden&#39;
    var: &#39;mt&#39;, &#39;n_cells_by_counts&#39;, &#39;mean_counts&#39;, &#39;pct_dropout_by_counts&#39;, &#39;total_counts&#39;, &#39;ribo&#39;, &#39;infog_var&#39;, &#39;highly_variable&#39;
    uns: &#39;Sample_colors&#39;, &#39;log1p&#39;, &#39;neighbors&#39;, &#39;umap&#39;, &#39;CellTypes_predicted_colors&#39;, &#39;Leiden&#39;, &#39;Leiden_colors&#39;, &#39;cosg&#39;, &#39;dendrogram_Leiden&#39;
    obsm: &#39;X_svd&#39;, &#39;X_umap&#39;, &#39;CellTypes_predicted_score&#39;, &#39;CellTypes_predicted_nlog10pvals&#39;
    layers: &#39;infog&#39;, &#39;log1p&#39;, &#39;raw&#39;
    obsp: &#39;connectivities&#39;, &#39;distances&#39;
</pre></div></div>
</div>
</section>
</section>
<section id="2.-INFOG-Normalization">
<h3>2. INFOG Normalization<a class="headerlink" href="#2.-INFOG-Normalization" title="Link to this heading">#</a></h3>
<p>It is important to re-run INFOG normalization and dimensionality reduction after filtering out cells, to accurately capture the current cell population.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
piaso.tl.infog(adata,
               copy=False,
               inplace=False,
               n_top_genes=3000,
               key_added=&#39;infog&#39;,
               key_added_highly_variable_gene=&#39;highly_variable&#39;,
               layer=&#39;raw&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The normalized data is saved as `infog` in `adata.layers`.
The highly variable genes are saved as `highly_variable` in `adata.var`.
Finished INFOG normalization.
CPU times: user 685 ms, sys: 4.9 s, total: 5.59 s
Wall time: 5.61 s
</pre></div></div>
</div>
</section>
<section id="id4">
<h3>Dimensionality reduction<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
piaso.tl.runSVD(adata,
                use_highly_variable=True,
                n_components=30,
                random_state=10,
                key_added=&#39;X_svd&#39;,
                layer=&#39;infog&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 4.72 s, sys: 0 ns, total: 4.72 s
Wall time: 656 ms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
sc.pp.neighbors(adata,
                use_rep=&#39;X_svd&#39;,
                n_neighbors=15,
                random_state=10,
                knn=True,
                method=&quot;umap&quot;)

sc.tl.umap(adata)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 25.4 s, sys: 11.8 ms, total: 25.4 s
Wall time: 21 s
</pre></div></div>
</div>
</section>
<section id="id5">
<h3>Predict cell types based on marker gene sets<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
piaso.tl.predictCellTypeByMarker(adata,
                                 marker_gene_set=marker_gene_dict,
                                 score_method=&#39;piaso&#39;,
                                 use_rep=&#39;X_svd&#39;,
                                 use_score=False,
                                 key_added = &#39;CellTypes_predicted&#39;,
                                 smooth_prediction=True,
                                 inplace=True)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Calculating gene set scores using piaso method...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Scoring gene sets: 100%|██████████| 29/29 [00:17&lt;00:00,  1.69set/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Predicting cell types based on marker gene p-values...
Smoothing cell type predictions...
Smoothing cell type predictions from &#39;CellTypes_predicted_raw&#39; using 7-nearest neighbors
Smoothed predictions stored in adata.obs[&#39;CellTypes_predicted_smoothed&#39;]
Confidence scores stored in adata.obs[&#39;CellTypes_predicted_smoothed_confidence&#39;]
Modified 1402 cell labels (21.27% of total)
Cell type prediction completed. Results saved to:
  - adata.obs[&#39;CellTypes_predicted&#39;]: predicted cell types
  - adata.obsm[&#39;CellTypes_predicted_score&#39;]: full score matrix
  - adata.obsm[&#39;CellTypes_predicted_nlog10pvals&#39;]: full -log10(p-value) matrix
  - adata.obs[&#39;CellTypes_predicted_nlog10pvals&#39;]: maximum -log10(p-values)
  - adata.obs[&#39;CellTypes_predicted_raw&#39;]: original unsmoothed predictions
  - adata.obs[&#39;CellTypes_predicted_confidence_smoothed&#39;]: smoothing confidence scores
CPU times: user 10.3 s, sys: 103 ms, total: 10.4 s
Wall time: 24.6 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;CellTypes_predicted&#39;],
           groups=[&#39;CD8aa&#39;],
           palette=piaso.pl.color.d_color20,
           legend_fontsize=8,
           legend_fontoutline=1,
           # legend_loc=&#39;on data&#39;,
           ncols=1,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_96_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_96_0.png" style="width: 312px; height: 277px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;CellTypes_predicted&#39;],
           # groups=[&#39;CD8aa&#39;],
           palette=piaso.pl.color.d_color20,
           legend_fontsize=8,
           legend_fontoutline=1,
           # legend_loc=&#39;on data&#39;,
           ncols=1,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_97_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_97_0.png" style="width: 478px; height: 277px;" />
</div>
</div>
</section>
<section id="id6">
<h3>Identify marker genes with COSG<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time
n_gene=30
cosg.cosg(adata,
          key_added=&#39;cosg&#39;,
          use_raw=False,
          layer=&#39;infog&#39;,
          mu=100,
          expressed_pct=0.1,
          remove_lowly_expressed=True,
          n_genes_user=n_gene,
          groupby=&#39;CellTypes_predicted&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 723 ms, sys: 98.9 ms, total: 822 ms
Wall time: 825 ms
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>marker_gene=pd.DataFrame(adata.uns[&#39;cosg&#39;][&#39;names&#39;])
marker_gene
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ASDC</th>
      <th>CD8aa</th>
      <th>CD14 monocyte</th>
      <th>CD16 monocyte</th>
      <th>CD56bright NK cell</th>
      <th>CD56dim NK cell</th>
      <th>DN T cell</th>
      <th>Effector B cell</th>
      <th>Erythrocyte</th>
      <th>ILC</th>
      <th>...</th>
      <th>Naive CD4 T cell</th>
      <th>Naive CD8 T cell</th>
      <th>Plasma cell</th>
      <th>Proliferating NK cell</th>
      <th>Transitional B cell</th>
      <th>Treg</th>
      <th>cDC1</th>
      <th>cDC2</th>
      <th>gdT</th>
      <th>pDC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>IGLV5-52</td>
      <td>AC005944.1</td>
      <td>DYSF</td>
      <td>AC104809.2</td>
      <td>XCL1</td>
      <td>BNC2</td>
      <td>AC004490.1</td>
      <td>SOX5</td>
      <td>LINC01241</td>
      <td>LHX6</td>
      <td>...</td>
      <td>ANKRD55</td>
      <td>AL590006.1</td>
      <td>IGHA1</td>
      <td>AL096677.2</td>
      <td>RAPGEF5</td>
      <td>FOXP3</td>
      <td>PLS3-AS1</td>
      <td>FCER1A</td>
      <td>TRDC</td>
      <td>LINC01478</td>
    </tr>
    <tr>
      <th>1</th>
      <td>AC012313.2</td>
      <td>AL031590.1</td>
      <td>CRISPLD2</td>
      <td>CDKN1C</td>
      <td>SPTSSB</td>
      <td>MYOM2</td>
      <td>AP001360.2</td>
      <td>PTCHD1-AS</td>
      <td>AL139023.1</td>
      <td>AL353689.3</td>
      <td>...</td>
      <td>EDAR</td>
      <td>NRCAM</td>
      <td>IGLV7-43</td>
      <td>IGKV1-9</td>
      <td>TTC28</td>
      <td>LINC02694</td>
      <td>STRA6</td>
      <td>CLEC10A</td>
      <td>TRGC1</td>
      <td>AC097375.1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>EPB41L4B</td>
      <td>TNIP3</td>
      <td>VCAN</td>
      <td>GPR20</td>
      <td>CABLES1</td>
      <td>LINGO2</td>
      <td>AL162427.1</td>
      <td>FCRL5</td>
      <td>AL021937.4</td>
      <td>AC005520.3</td>
      <td>...</td>
      <td>FHIT</td>
      <td>NELL2</td>
      <td>JCHAIN</td>
      <td>IGHV3-66</td>
      <td>MYBL2</td>
      <td>HACD1</td>
      <td>AC090907.1</td>
      <td>ENHO</td>
      <td>TRGV9</td>
      <td>CUX2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>AC145207.1</td>
      <td>ZSCAN26</td>
      <td>PADI4</td>
      <td>LYPD2</td>
      <td>TNFRSF11A</td>
      <td>SPON2</td>
      <td>PGAM4</td>
      <td>CLECL1</td>
      <td>AC105213.1</td>
      <td>AL109955.2</td>
      <td>...</td>
      <td>PLCL1</td>
      <td>LINC02446</td>
      <td>TNFRSF17</td>
      <td>AC027279.2</td>
      <td>GPM6A</td>
      <td>AC013652.1</td>
      <td>DCLK3</td>
      <td>CD1E</td>
      <td>KLRC1</td>
      <td>LRRC26</td>
    </tr>
    <tr>
      <th>4</th>
      <td>SLC24A5</td>
      <td>PDGFB</td>
      <td>NRG1</td>
      <td>PPP1R17</td>
      <td>PPP1R9A</td>
      <td>MIR181A2HG</td>
      <td>ALDH3B2</td>
      <td>AL592429.2</td>
      <td>CCL26</td>
      <td>AL662844.3</td>
      <td>...</td>
      <td>KANK1</td>
      <td>GLIS3</td>
      <td>IGHV3-15</td>
      <td>DUSP13</td>
      <td>AL031595.3</td>
      <td>FANK1</td>
      <td>AC108169.1</td>
      <td>CD1C</td>
      <td>CCL5</td>
      <td>AC023590.1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>LINC00664</td>
      <td>AL121839.2</td>
      <td>FCAR</td>
      <td>AC020651.2</td>
      <td>ZMAT4</td>
      <td>GRIK4</td>
      <td>AC007029.1</td>
      <td>GPM6A</td>
      <td>AC074011.1</td>
      <td>AC007370.1</td>
      <td>...</td>
      <td>TSHZ2</td>
      <td>CA6</td>
      <td>TXNDC5</td>
      <td>TCF23</td>
      <td>HS3ST1</td>
      <td>RTKN2</td>
      <td>ANKRD65</td>
      <td>ST18</td>
      <td>A2M</td>
      <td>EPHB1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>MOBP</td>
      <td>AMIGO1</td>
      <td>LUCAT1</td>
      <td>CROCC2</td>
      <td>SERPINE1</td>
      <td>SORBS2</td>
      <td>AC010255.1</td>
      <td>TNFRSF13B</td>
      <td>AC026765.3</td>
      <td>AC007998.4</td>
      <td>...</td>
      <td>MAL</td>
      <td>CD8B</td>
      <td>IGKV3-15</td>
      <td>TRHR</td>
      <td>P2RX5</td>
      <td>DUSP4</td>
      <td>AL118508.1</td>
      <td>NCKAP5</td>
      <td>PZP</td>
      <td>LILRA4</td>
    </tr>
    <tr>
      <th>7</th>
      <td>AL138999.2</td>
      <td>ZSCAN2</td>
      <td>AL163541.1</td>
      <td>VMO1</td>
      <td>KLRC2</td>
      <td>FGFBP2</td>
      <td>LINC01865</td>
      <td>NIPSNAP3B</td>
      <td>C12orf56</td>
      <td>LRRC66</td>
      <td>...</td>
      <td>LEF1</td>
      <td>FCGBP</td>
      <td>MIXL1</td>
      <td>FAM215A</td>
      <td>AC060234.3</td>
      <td>CTLA4</td>
      <td>AC026391.1</td>
      <td>PKIB</td>
      <td>GNLY</td>
      <td>PTPRS</td>
    </tr>
    <tr>
      <th>8</th>
      <td>ZSCAN23</td>
      <td>AL359706.1</td>
      <td>CXCL8</td>
      <td>CKB</td>
      <td>AC002429.2</td>
      <td>CD160</td>
      <td>AL121757.2</td>
      <td>MS4A1</td>
      <td>SPATA41</td>
      <td>AC084082.1</td>
      <td>...</td>
      <td>ITGA6</td>
      <td>LRRN3</td>
      <td>IGLC2</td>
      <td>AL133297.1</td>
      <td>JUP</td>
      <td>STAM</td>
      <td>PRSS48</td>
      <td>MRC1</td>
      <td>IL12RB2</td>
      <td>PTCRA</td>
    </tr>
    <tr>
      <th>9</th>
      <td>AL445123.2</td>
      <td>STYK1</td>
      <td>MCEMP1</td>
      <td>LINC02345</td>
      <td>RAMP1</td>
      <td>LINC01505</td>
      <td>TEK</td>
      <td>ZBTB20-AS5</td>
      <td>CMTM2</td>
      <td>PCAT6</td>
      <td>...</td>
      <td>MLLT3</td>
      <td>PDE3B</td>
      <td>IGHV3-30</td>
      <td>LINC01005</td>
      <td>BCL7A</td>
      <td>IL2RA</td>
      <td>ALOX15</td>
      <td>LRP1B</td>
      <td>S100B</td>
      <td>LAMP5</td>
    </tr>
    <tr>
      <th>10</th>
      <td>AC002347.1</td>
      <td>ZNF681</td>
      <td>LIN7A</td>
      <td>LINC02085</td>
      <td>IGFBP4</td>
      <td>RHOBTB3</td>
      <td>AC116407.1</td>
      <td>EML6</td>
      <td>AP001005.3</td>
      <td>LINC02815</td>
      <td>...</td>
      <td>FAM153A</td>
      <td>THEMIS</td>
      <td>MZB1</td>
      <td>AC006960.3</td>
      <td>EFCAB11</td>
      <td>CDHR3</td>
      <td>CYP24A1</td>
      <td>CLIC2</td>
      <td>LINC00612</td>
      <td>KCNA5</td>
    </tr>
    <tr>
      <th>11</th>
      <td>STRA8</td>
      <td>RNFT2</td>
      <td>CSF3R</td>
      <td>HES4</td>
      <td>STYK1</td>
      <td>SH2D1B</td>
      <td>AC020907.1</td>
      <td>ANKRD33B</td>
      <td>AC006116.8</td>
      <td>NOL4L-DT</td>
      <td>...</td>
      <td>LINC01891</td>
      <td>APBA2</td>
      <td>SDC1</td>
      <td>AC022517.1</td>
      <td>CORO2B</td>
      <td>ZC2HC1A</td>
      <td>ENPP1</td>
      <td>IL1R2</td>
      <td>KLRG1</td>
      <td>CLEC4C</td>
    </tr>
    <tr>
      <th>12</th>
      <td>AP001094.2</td>
      <td>METTL18</td>
      <td>NLRP12</td>
      <td>FMNL2</td>
      <td>NCAM1</td>
      <td>RNF165</td>
      <td>AC027130.1</td>
      <td>IL7</td>
      <td>FXYD6</td>
      <td>AC116158.2</td>
      <td>...</td>
      <td>PRKCA</td>
      <td>SNTG2</td>
      <td>GPRC5D</td>
      <td>PKMYT1</td>
      <td>AL365272.1</td>
      <td>AC011997.1</td>
      <td>DNAAF3</td>
      <td>HTR7</td>
      <td>TGFBR3</td>
      <td>AL513493.1</td>
    </tr>
    <tr>
      <th>13</th>
      <td>AC112512.1</td>
      <td>TMEM116</td>
      <td>WLS</td>
      <td>CEACAM3</td>
      <td>IL12RB2</td>
      <td>LINC00298</td>
      <td>AC090125.1</td>
      <td>OSBPL10</td>
      <td>TNS1</td>
      <td>TBC1D8-AS1</td>
      <td>...</td>
      <td>AK5</td>
      <td>CACHD1</td>
      <td>GLDC</td>
      <td>IGLC1</td>
      <td>PAOX</td>
      <td>IKZF2</td>
      <td>CFB</td>
      <td>DTNA</td>
      <td>DUSP2</td>
      <td>SCT</td>
    </tr>
    <tr>
      <th>14</th>
      <td>NPAS1</td>
      <td>BCAT2</td>
      <td>PRICKLE1</td>
      <td>SMIM25</td>
      <td>KLRC3</td>
      <td>PRF1</td>
      <td>AC018437.3</td>
      <td>CD82</td>
      <td>PPFIA3</td>
      <td>OTX2-AS1</td>
      <td>...</td>
      <td>MAN1C1</td>
      <td>LEF1</td>
      <td>IGHV3-33</td>
      <td>TERT</td>
      <td>TCL1A</td>
      <td>MCF2L2</td>
      <td>ARHGEF26-AS1</td>
      <td>FLT3</td>
      <td>CYB561</td>
      <td>FAM160A1-DT</td>
    </tr>
    <tr>
      <th>15</th>
      <td>GATA4</td>
      <td>VIPR1-AS1</td>
      <td>SPOCK1</td>
      <td>NEURL1</td>
      <td>ROR1</td>
      <td>KLRF1</td>
      <td>GFRA3</td>
      <td>AL355076.2</td>
      <td>AC005332.3</td>
      <td>NGB</td>
      <td>...</td>
      <td>FAM153B</td>
      <td>PSMA1</td>
      <td>PLAAT2</td>
      <td>PAGE2B</td>
      <td>AL139020.1</td>
      <td>CCDC141</td>
      <td>AC107918.5</td>
      <td>ADGRG6</td>
      <td>SH3BGRL3</td>
      <td>LINC01724</td>
    </tr>
    <tr>
      <th>16</th>
      <td>C20orf144</td>
      <td>ZNF268</td>
      <td>GLT1D1</td>
      <td>CLEC4F</td>
      <td>EFHC2</td>
      <td>IGFBP7</td>
      <td>LINC01339</td>
      <td>ANGPTL1</td>
      <td>AL589935.1</td>
      <td>CCDC40</td>
      <td>...</td>
      <td>SLC22A23</td>
      <td>SH3RF3</td>
      <td>IGHV3-23</td>
      <td>IGLV2-11</td>
      <td>MCF2L</td>
      <td>TTN</td>
      <td>LINC01845</td>
      <td>SH3BP4</td>
      <td>AC010175.1</td>
      <td>AC018643.1</td>
    </tr>
    <tr>
      <th>17</th>
      <td>EXOC3L2</td>
      <td>LYSMD4</td>
      <td>CYP1B1</td>
      <td>PAPSS2</td>
      <td>XCL2</td>
      <td>NMUR1</td>
      <td>AC009435.1</td>
      <td>FCRL2</td>
      <td>AC008649.2</td>
      <td>AL161757.4</td>
      <td>...</td>
      <td>TRABD2A</td>
      <td>LEF1-AS1</td>
      <td>IGKC</td>
      <td>CDC45</td>
      <td>TCL6</td>
      <td>F5</td>
      <td>AL122008.4</td>
      <td>CST3</td>
      <td>A2M-AS1</td>
      <td>LINC01226</td>
    </tr>
    <tr>
      <th>18</th>
      <td>VWC2</td>
      <td>KLRC4</td>
      <td>ACSL1</td>
      <td>TCF7L2</td>
      <td>CCNJL</td>
      <td>SLCO4C1</td>
      <td>AC015631.1</td>
      <td>RALGPS2</td>
      <td>C17orf64</td>
      <td>AF233439.1</td>
      <td>...</td>
      <td>IL6ST</td>
      <td>AC002460.2</td>
      <td>DERL3</td>
      <td>IGHV5-51</td>
      <td>IGHD</td>
      <td>TOX</td>
      <td>ADORA3</td>
      <td>SLAMF8</td>
      <td>KLRD1</td>
      <td>AC011893.1</td>
    </tr>
    <tr>
      <th>19</th>
      <td>CLEC18A</td>
      <td>TNFRSF9</td>
      <td>VCAN-AS1</td>
      <td>C1QA</td>
      <td>B4GALT6</td>
      <td>LDB2</td>
      <td>CA10</td>
      <td>FCRLA</td>
      <td>AC011092.3</td>
      <td>MIA</td>
      <td>...</td>
      <td>EPHX2</td>
      <td>EPHA1-AS1</td>
      <td>ITGA8</td>
      <td>AC100827.4</td>
      <td>CR2</td>
      <td>IATPR</td>
      <td>CTSV</td>
      <td>DANT2</td>
      <td>RAB9A</td>
      <td>AR</td>
    </tr>
    <tr>
      <th>20</th>
      <td>LINC02033</td>
      <td>STK36</td>
      <td>LINC00937</td>
      <td>KNDC1</td>
      <td>TNFRSF18</td>
      <td>PRSS23</td>
      <td>AL139042.1</td>
      <td>GEN1</td>
      <td>AC069549.1</td>
      <td>STXBP5L</td>
      <td>...</td>
      <td>AC139720.1</td>
      <td>OXNAD1</td>
      <td>ZNF215</td>
      <td>IGHGP</td>
      <td>PPAN</td>
      <td>DCP1B</td>
      <td>CERS6-AS1</td>
      <td>CYP2S1</td>
      <td>NKG7</td>
      <td>PHEX</td>
    </tr>
    <tr>
      <th>21</th>
      <td>AC025263.1</td>
      <td>LINC01118</td>
      <td>PROK2</td>
      <td>ICAM4</td>
      <td>GNLY</td>
      <td>AKR1C3</td>
      <td>AC092844.1</td>
      <td>ACP5</td>
      <td>LRRC42</td>
      <td>HCRTR1</td>
      <td>...</td>
      <td>CAMK4</td>
      <td>CCR7</td>
      <td>AC136431.1</td>
      <td>AC012676.3</td>
      <td>CD79B</td>
      <td>AC093865.1</td>
      <td>CLEC9A</td>
      <td>NEGR1</td>
      <td>C1orf21</td>
      <td>COL26A1</td>
    </tr>
    <tr>
      <th>22</th>
      <td>AC091180.2</td>
      <td>C21orf62-AS1</td>
      <td>TREM1</td>
      <td>SFTPD</td>
      <td>KLRC1</td>
      <td>PDGFD</td>
      <td>IMPG1</td>
      <td>CD79B</td>
      <td>SLC29A1</td>
      <td>AC096570.1</td>
      <td>...</td>
      <td>CCR7</td>
      <td>SCML1</td>
      <td>IGF1</td>
      <td>ANLN</td>
      <td>DPF3</td>
      <td>CYTOR</td>
      <td>AC108449.2</td>
      <td>HLA-DRB1</td>
      <td>GZMH</td>
      <td>LINC00865</td>
    </tr>
    <tr>
      <th>23</th>
      <td>NRXN2</td>
      <td>KLHL25</td>
      <td>EREG</td>
      <td>LST1</td>
      <td>ATP8B4</td>
      <td>CHST2</td>
      <td>C18orf63</td>
      <td>CD79A</td>
      <td>TPRN</td>
      <td>SRR</td>
      <td>...</td>
      <td>IGF1R</td>
      <td>CD8A</td>
      <td>APOBEC3B</td>
      <td>AC003043.1</td>
      <td>KMO</td>
      <td>DUSP16</td>
      <td>BBOX1</td>
      <td>LHFPL6</td>
      <td>GZMA</td>
      <td>NRP1</td>
    </tr>
    <tr>
      <th>24</th>
      <td>SIGLEC15</td>
      <td>SLC35C1</td>
      <td>AC020916.1</td>
      <td>FCGR3A</td>
      <td>NCALD</td>
      <td>IL2RB</td>
      <td>AURKC</td>
      <td>EBF1</td>
      <td>ZBED5-AS1</td>
      <td>AC091057.6</td>
      <td>...</td>
      <td>NDFIP1</td>
      <td>PRKAR1B</td>
      <td>IGLV2-14</td>
      <td>AL359091.5</td>
      <td>IGHM</td>
      <td>PHF19</td>
      <td>AC093158.1</td>
      <td>ITGB5</td>
      <td>GZMM</td>
      <td>CYYR1</td>
    </tr>
    <tr>
      <th>25</th>
      <td>AL138694.1</td>
      <td>DHRS13</td>
      <td>PLAUR</td>
      <td>PDE8B</td>
      <td>HOPX</td>
      <td>NCR1</td>
      <td>GPR176</td>
      <td>DENND5B</td>
      <td>LINC01010</td>
      <td>AL359504.2</td>
      <td>...</td>
      <td>AL109930.1</td>
      <td>MAML2</td>
      <td>AC009570.2</td>
      <td>MELK</td>
      <td>CD22</td>
      <td>NIBAN1</td>
      <td>AC092661.1</td>
      <td>HLA-DPB1</td>
      <td>IL32</td>
      <td>ARPP21</td>
    </tr>
    <tr>
      <th>26</th>
      <td>AC008764.6</td>
      <td>MED12</td>
      <td>CD36</td>
      <td>IFITM3</td>
      <td>CD7</td>
      <td>GFOD1</td>
      <td>AC087564.1</td>
      <td>TLR9</td>
      <td>BRI3BP</td>
      <td>HTR2C</td>
      <td>...</td>
      <td>KLHL29</td>
      <td>LRRC7</td>
      <td>DCC</td>
      <td>GINS2</td>
      <td>PCDH9</td>
      <td>COX10-AS1</td>
      <td>LDLRAD2</td>
      <td>FBLN2</td>
      <td>GZMK</td>
      <td>FAM160A1</td>
    </tr>
    <tr>
      <th>27</th>
      <td>AL031709.1</td>
      <td>TRPC1</td>
      <td>TNFAIP6</td>
      <td>FAM20A</td>
      <td>IL2RB</td>
      <td>CLIC3</td>
      <td>PRSS51</td>
      <td>ZDHHC21</td>
      <td>PDXP</td>
      <td>AL035658.1</td>
      <td>...</td>
      <td>LINC01550</td>
      <td>NR3C2</td>
      <td>BMP6</td>
      <td>APOBEC3B-AS1</td>
      <td>CEP89</td>
      <td>LINC00426</td>
      <td>IAPP</td>
      <td>HLA-DPA1</td>
      <td>LYAR</td>
      <td>AC104819.3</td>
    </tr>
    <tr>
      <th>28</th>
      <td>PCBP2-OT1</td>
      <td>TULP2</td>
      <td>CYP1B1-AS1</td>
      <td>MS4A7</td>
      <td>NCR1</td>
      <td>TTC38</td>
      <td>LINC00970</td>
      <td>TLR10</td>
      <td>ZNF653</td>
      <td>MRVI1</td>
      <td>...</td>
      <td>CHRM3-AS2</td>
      <td>SERINC5</td>
      <td>NT5DC2</td>
      <td>SPC25</td>
      <td>ZNF318</td>
      <td>LDLRAD4</td>
      <td>AC133961.1</td>
      <td>ZNF366</td>
      <td>HCST</td>
      <td>SRPX</td>
    </tr>
    <tr>
      <th>29</th>
      <td>CPT1C</td>
      <td>AC137810.1</td>
      <td>RBM47</td>
      <td>SIGLEC10</td>
      <td>CTSW</td>
      <td>ADGRG1</td>
      <td>LINC01090</td>
      <td>AC090541.1</td>
      <td>LRRC37A</td>
      <td>AC036176.1</td>
      <td>...</td>
      <td>TCF7</td>
      <td>ABLIM1</td>
      <td>ITM2C</td>
      <td>AC015878.1</td>
      <td>FCRLA</td>
      <td>CASK</td>
      <td>CADM1</td>
      <td>EMP1</td>
      <td>TRGC2</td>
      <td>LINC00996</td>
    </tr>
  </tbody>
</table>
<p>30 rows × 26 columns</p>
</div></div>
</div>
<p>We can use a dendrogram dot plot to visualize the expression of the top three marker genes of each predicted cell type.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.tl.dendrogram(adata,groupby=&#39;CellTypes_predicted&#39;,use_rep=&#39;X_svd&#39;)
df_tmp=pd.DataFrame(adata.uns[&#39;cosg&#39;][&#39;names&#39;][:3,]).T
df_tmp=df_tmp.reindex(adata.uns[&#39;dendrogram_&#39;+&#39;CellTypes_predicted&#39;][&#39;categories_ordered&#39;])
marker_genes_list={idx: list(row.values) for idx, row in df_tmp.iterrows()}
marker_genes_list = {k: v for k, v in marker_genes_list.items() if not any(isinstance(x, float) for x in v)}

sc.pl.dotplot(adata,
              marker_genes_list,
              groupby=&#39;CellTypes_predicted&#39;,
              layer=&#39;infog&#39;,
              dendrogram=True,
              swap_axes=False,
              standard_scale=&#39;var&#39;,
              cmap=&#39;Spectral_r&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_102_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_102_0.png" style="width: 2109px; height: 820px;" />
</div>
</div>
<section id="Marker-genes-for-CD8aa-monocyte">
<h4>Marker genes for CD8aa monocyte<a class="headerlink" href="#Marker-genes-for-CD8aa-monocyte" title="Link to this heading">#</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cluster_check = &#39;CD8aa&#39;
marker_gene[cluster_check].values
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;AC005944.1&#39;, &#39;AL031590.1&#39;, &#39;TNIP3&#39;, &#39;ZSCAN26&#39;, &#39;PDGFB&#39;,
       &#39;AL121839.2&#39;, &#39;AMIGO1&#39;, &#39;ZSCAN2&#39;, &#39;AL359706.1&#39;, &#39;STYK1&#39;, &#39;ZNF681&#39;,
       &#39;RNFT2&#39;, &#39;METTL18&#39;, &#39;TMEM116&#39;, &#39;BCAT2&#39;, &#39;VIPR1-AS1&#39;, &#39;ZNF268&#39;,
       &#39;LYSMD4&#39;, &#39;KLRC4&#39;, &#39;TNFRSF9&#39;, &#39;STK36&#39;, &#39;LINC01118&#39;, &#39;C21orf62-AS1&#39;,
       &#39;KLHL25&#39;, &#39;SLC35C1&#39;, &#39;DHRS13&#39;, &#39;MED12&#39;, &#39;TRPC1&#39;, &#39;TULP2&#39;,
       &#39;AC137810.1&#39;], dtype=object)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.umap(adata,
           color=[&#39;RNF26&#39;, &#39;BCKDK&#39;, &#39;STYK1&#39;, &#39;ZNF268&#39;, &#39;RNFT2&#39;, &#39;BICRA-AS1&#39;,
       &#39;ZNF510&#39;, &#39;AMIGO1&#39;, &#39;MIER3&#39;, &#39;AC013437.1&#39;, &#39;SLC24A1&#39;, &#39;LAGE3&#39;],
           cmap=piaso.pl.color.c_color1,
           palette=piaso.pl.color.d_color1,
           ncols=3,
           size=10,
           frameon=False)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_105_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_105_0.png" style="width: 954px; height: 1124px;" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>sc.pl.dotplot(adata,
              marker_gene[cluster_check].values[:30],
              groupby=&#39;CellTypes_predicted&#39;,
              dendrogram=False,
              swap_axes=True,
              standard_scale=&#39;var&#39;,
              cmap=&#39;Spectral_r&#39;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_106_0.png" class="no-scaled-link" src="../_images/notebooks_05_scRNAseqProcessingTutorial_SAN1SAN2_106_0.png" style="width: 808px; height: 855px;" />
</div>
</div>
</section>
</section>
</section>
<section id="id7">
<h2>Save the data<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[138]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>np.unique(adata.obs[&#39;CellTypes_predicted&#39;])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[138]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;ASDC&#39;, &#39;CD14 monocyte&#39;, &#39;CD16 monocyte&#39;, &#39;CD56bright NK cell&#39;,
       &#39;CD56dim NK cell&#39;, &#39;CD8aa&#39;, &#39;DN T cell&#39;, &#39;Effector B cell&#39;,
       &#39;Erythrocyte&#39;, &#39;ILC&#39;, &#39;Intermediate monocyte&#39;, &#39;MAIT&#39;,
       &#39;Memory B cell&#39;, &#39;Memory CD4 T cell&#39;, &#39;Memory CD8 T cell&#39;,
       &#39;Naive B cell&#39;, &#39;Naive CD4 T cell&#39;, &#39;Naive CD8 T cell&#39;,
       &#39;Plasma cell&#39;, &#39;Proliferating NK cell&#39;, &#39;Transitional B cell&#39;,
       &#39;Treg&#39;, &#39;cDC1&#39;, &#39;cDC2&#39;, &#39;gdT&#39;, &#39;pDC&#39;], dtype=object)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata.write(save_dir + &#39;/&#39; + prefix + &#39;_QC.h5ad&#39;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>adata = sc.read(save_dir + &#39;/&#39; + prefix + &#39;_QC.h5ad&#39;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>marker_gene.to_csv(save_dir + &#39;/&#39; + prefix + &#39;_CellType_markerGenes.csv&#39;)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!/home/vas744/Software/gdrive files upload --parent 1QpSnNAtb516HZ4jEooTVvjIoo_d8mOh0 /n/scratch/users/v/vas744/Results/single-cell/Methods/DataProcessing/PBMCMultiomeRop2023_SAN1_SAN2/HumanPBMCs_Multiome_RNA_QC.h5ad
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Uploading /n/scratch/users/v/vas744/Results/single-cell/Methods/DataProcessing/PBMCMultiomeRop2023_SAN1_SAN2/HumanPBMCs_Multiome_RNA_QC.h5ad
File successfully uploaded
Id: 1bpWCqhadqw29Av9RsqAJqWW7kmEpQOHQ
Name: HumanPBMCs_Multiome_RNA_QC.h5ad
Mime: application/octet-stream
Size: 318.5 MB
Created: 2026-01-20 14:02:15
Modified: 2026-01-20 14:02:15
MD5: bdd76ad91aa88845d0791327f8675972
Shared: True
Parents: 1QpSnNAtb516HZ4jEooTVvjIoo_d8mOh0
ViewUrl: https://drive.google.com/file/d/1bpWCqhadqw29Av9RsqAJqWW7kmEpQOHQ/view?usp=drivesdk
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!/home/vas744/Software/gdrive files upload --parent 1QpSnNAtb516HZ4jEooTVvjIoo_d8mOh0 /n/scratch/users/v/vas744/Results/single-cell/Methods/DataProcessing/PBMCMultiomeRop2023_SAN1_SAN2/HumanPBMCs_Multiome_RNA_raw_QC.h5ad
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Uploading /n/scratch/users/v/vas744/Results/single-cell/Methods/DataProcessing/PBMCMultiomeRop2023_SAN1_SAN2/HumanPBMCs_Multiome_RNA_raw_QC.h5ad
File successfully uploaded
Id: 1DaeasGmgNIBuppSkqT_jiRMDCouxEuiN
Name: HumanPBMCs_Multiome_RNA_raw_QC.h5ad
Mime: application/octet-stream
Size: 407.7 MB
Created: 2026-01-20 14:02:26
Modified: 2026-01-20 14:02:26
MD5: 97852a95d1b331836930c376a5aed3e5
Shared: True
Parents: 1QpSnNAtb516HZ4jEooTVvjIoo_d8mOh0
ViewUrl: https://drive.google.com/file/d/1DaeasGmgNIBuppSkqT_jiRMDCouxEuiN/view?usp=drivesdk
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>!/home/vas744/Software/gdrive files upload --parent 1QpSnNAtb516HZ4jEooTVvjIoo_d8mOh0 /n/scratch/users/v/vas744/Results/single-cell/Methods/DataProcessing/PBMCMultiomeRop2023_SAN1_SAN2/HumanPBMCs_Multiome_RNA_CellType_markerGenes.csv
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Uploading /n/scratch/users/v/vas744/Results/single-cell/Methods/DataProcessing/PBMCMultiomeRop2023_SAN1_SAN2/HumanPBMCs_Multiome_RNA_CellType_markerGenes.csv
File successfully uploaded
Id: 1BLabNMEkVlHfbooFe55jD9d1yrcl_66K
Name: HumanPBMCs_Multiome_RNA_CellType_markerGenes.csv
Mime: text/csv
Size: 6.1 KB
Created: 2026-01-20 14:02:28
Modified: 2026-01-20 14:02:28
MD5: 1ac8ebc9c6b336588015cb2be1ed9432
Shared: True
Parents: 1QpSnNAtb516HZ4jEooTVvjIoo_d8mOh0
ViewUrl: https://drive.google.com/file/d/1BLabNMEkVlHfbooFe55jD9d1yrcl_66K/view?usp=drivesdk
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="scRNAseqProcessingTutorial_SAN2.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Pre-processing CellRanger outputs (single sample, Human PBMCs)</p>
      </div>
    </a>
    <a class="right-next"
       href="rnaSeqPipelineTutorial_mouse.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Pre-processing CellRanger outputs (single sample, mouse brain)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Download-the-data">Download the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Load-the-data">Load the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Quality-Control">Quality Control</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Filter-cells-based-on-gene-counts">Filter cells based on gene counts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Calculate-cell-quality-metrics">Calculate cell quality metrics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Doublet-prediction">Doublet prediction</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#log1p-Normalization">log1p Normalization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#INFOG-Normalization">INFOG Normalization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Dimensionality-reduction">Dimensionality reduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Save-the-data">Save the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Filtering-cells">Filtering cells</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Annotation">Annotation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Preprocessing-cell-type-specific-marker-gene-sets">Preprocessing cell type-specific marker gene sets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#1.-INFOG-Normalization">1. INFOG Normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Dimensionality reduction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Predict-cell-types-based-on-marker-gene-sets">Predict cell types based on marker gene sets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Clustering">Clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Identify-marker-genes-with-COSG">Identify marker genes with COSG</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Removal-of-low-quality-cells">Removal of low-quality cells</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#Checking-potential-low-quality-clusters">Checking potential low quality clusters</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#2.-INFOG-Normalization">2. INFOG Normalization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Dimensionality reduction</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Predict cell types based on marker gene sets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Identify marker genes with COSG</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#Marker-genes-for-CD8aa-monocyte">Marker genes for CD8aa monocyte</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Save the data</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Min Dai.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>